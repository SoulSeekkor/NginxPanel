@page "/configs"

@using NginxPanel.Services;

@inject DialogService DialogService;
@inject Services.Nginx nginx;

<PageTitle>Nginx Panel - Configs</PageTitle>

@if (nginx.Installed)
{
	<RadzenLayout Style="max-height: 800px;">
		<RadzenHeader>
			<RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
				<RadzenStack Orientation="Orientation.Horizontal">
					<RadzenSidebarToggle Click="@(() => configsSidebarExpanded = !configsSidebarExpanded)" />
					<RadzenButton Click=@(() => RefreshConfigs(true)) Disabled="busyRefreshing" Text="Refresh" Icon="cached" BusyText="Refreshing..." IsBusy="busyRefreshing" class="rz-background-color-primary-dark rz-mr-5" />
					<RadzenButton Click=@(() => AddConfig()) Disabled="busyRefreshing" Text="Add" Icon="add" BusyText="Refreshing..." IsBusy="busyRefreshing" class="rz-background-color-success-dark" />
				</RadzenStack>

				@if (!(selectedConf is null) && !busyRefreshing)
				{
					// Display config actions
					<RadzenStack Orientation="Orientation.Horizontal">
						<RadzenButton Click=@(() => RenameConfig(selectedConf)) Disabled="busyRefreshing" Text="Rename" Icon="edit" class="rz-background-color-primary-dark" />
						<RadzenButton Click=@(() => DeleteConfig(selectedConf)) Disabled="busyRefreshing" Icon="delete" Size="ButtonSize.Medium" class="rz-background-color-danger-dark" />
					</RadzenStack>
				}
			</RadzenStack>
		</RadzenHeader>

		<RadzenDataGrid @ref="configsGrid" AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand" AllowSorting="true" Density="Density.Compact" Data="@nginx.Configs" TItem="Nginx.ConfigFile">
			<Columns>
				<RadzenDataGridColumn Width="50px" Title="#" Filterable="false" Sortable="false" TextAlign="TextAlign.Center">
					<Template Context="data">
						@(nginx.Configs.IndexOf(data) + 1)
					</Template>
				</RadzenDataGridColumn>
				<RadzenDataGridColumn Title="Active" TextAlign="TextAlign.Center" Width="100px">
					<Template Context="data">
						@if (data.ConfigType == Nginx.ConfigFile.enuConfigType.Site)
						{
							<RadzenSwitch TValue="bool" Value="@data.Enabled" Name="@data.Name" Change="() => ToggleSiteEnabled(data)" />
						}
					</Template>
				</RadzenDataGridColumn>
				<RadzenDataGridColumn Property="@nameof(Nginx.ConfigFile.Name)" Title="Name" Width="300px" />
				<RadzenDataGridColumn Property="@nameof(Nginx.ConfigFile.ServerName)" Title="Hostname" />
				<RadzenDataGridColumn Property="@nameof(Nginx.ConfigFile.ProxyPass)" Title="Target" Width="350px" />
				<RadzenDataGridColumn Width="160px" Title="Actions">
					<Template Context="data">
						<RadzenButton Variant="Variant.Flat" Shade="Shade.Lighter" Icon="edit" class="rz-m-1" Click=@(() => EditConfig(data)) title="Edit" />
						<RadzenButton Variant="Variant.Flat" Shade="Shade.Lighter" Icon="match_word" IconColor="blueviolet" class="rz-m-1" Click=@(() => RenameConfig(data)) title="Rename" />
						<RadzenButton Variant="Variant.Flat" Shade="Shade.Lighter" Icon="delete" IconColor="red" class="rz-m-1" Click=@(() => DeleteConfig(data)) title="Delete" />
					</Template>
				</RadzenDataGridColumn>
			</Columns>
		</RadzenDataGrid>
	</RadzenLayout>
}
else
{
	<RadzenText TextStyle="TextStyle.DisplayH5" class="rz-mt-5" TagName="TagName.H5">Nginx service was not found, you must install Nginx before using this page.</RadzenText>
}

@code {
	[CascadingParameter]
	private MainLayout? layout { get; set; }

	RadzenDataGrid<Nginx.ConfigFile>? configsGrid;

	private Nginx.ConfigFile? selectedConf = null;

	private bool configsSidebarExpanded = true;
	private bool busyRefreshing = false;

	private string configCurrentCSS = string.Empty;
	private const string defaultConfigCSS = "background-color: #5F737E !important; cursor: default; font-family: \"Lucida Console\", \"Courier New\", monospace; font-size: 11px; background: url(content/images/linenumbers.png); background-attachment: local; background-repeat: no-repeat; padding-left: 35px; padding-top: 12px; line-height:16px; border-color:#ccc;";
	private const string configNoWrapCSS = "white-space: nowrap;";

	protected override async Task OnInitializedAsync()
	{
		configCurrentCSS = configNoWrapCSS + defaultConfigCSS;
		await RefreshConfigs(false);
	}

	private async Task RefreshConfigs(bool notifyUser, string? selectConf = null)
	{
		try
		{
			busyRefreshing = true;
			selectedConf = null;

			await Task.Run(() => nginx.RefreshConfigs());

			if (!(selectConf is null))
			{
				selectedConf = nginx.Configs.FirstOrDefault(c => c.Name == selectConf);
			}

			if (notifyUser)
			{
				await layout!.DisplayToastAsync(MainLayout.toastType.info, "Configs refreshed successfully!");
			}
		}
		finally
		{
			busyRefreshing = false;
			await InvokeAsync(() => StateHasChanged());
		}
	}

	private async Task ToggleSiteEnabled(Services.Nginx.ConfigFile conf)
	{
		try
		{
			nginx.ToggleSiteEnabled(conf);

			if (conf.Enabled)
			{
				await layout!.DisplayToastAsync(MainLayout.toastType.success, $"Site config %ss%{conf.Name}%se% enabled successfully!");
			}
			else
			{
				await layout!.DisplayToastAsync(MainLayout.toastType.success, $"Site config %ss%{conf.Name}%se% disabled successfully!");
			}
		}
		catch
		{
			await layout!.DisplayToastAsync(MainLayout.toastType.error, $"Error occurred while updating site config %ss%{conf.Name}%se%!");
		}
	}

	private async Task SaveConfig(Nginx.ConfigFile conf)
	{
		try
		{
			conf.busySaving = true;

			await conf.Save();

			await layout!.DisplayToastAsync(MainLayout.toastType.success, $"Config %ss%{conf.Name}%se% saved successfully!");
		}
		catch
		{
			await layout!.DisplayToastAsync(MainLayout.toastType.error, $"Error occurred while saving config %ss%{conf.Name}%se%!");
		}
		finally
		{
			conf.busySaving = false;
			await InvokeAsync(() => StateHasChanged());
		}
	}

	private async Task RevertConfig(Nginx.ConfigFile conf)
	{
		try
		{
			string message = layout!.StyleMessage(MainLayout.toastType.success, $"Are you sure you want to revert config %ss%{conf.Name}%se%?  You will lose any changes you have made!");
			bool? confirm = await DialogService.Confirm(message, "Revert Config", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No", CloseDialogOnOverlayClick = true });

			if (confirm.HasValue && confirm.Value)
			{
				await conf.Revert();

				await layout!.DisplayToastAsync(MainLayout.toastType.info, $"Config %ss%{conf.Name}%se% has been reverted!");
			}
		}
		finally
		{
			await InvokeAsync(() => StateHasChanged());
		}
	}

	private async Task RenameConfig(Nginx.ConfigFile conf)
	{
		string configName = conf.Name;
		var result = await DialogService.OpenAsync("Rename Config", ds =>
			@<RadzenStack Gap="1.5rem">
				<RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Please enter the new name for this config below:</RadzenText>
				<RadzenTextBox @bind-Value=@configName class="w-100" />
				<RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
					<RadzenStack Orientation="Orientation.Horizontal">
						<RadzenButton Text="Ok" Click="() => ds.Close(true)" Style="width: 80px;" />
						<RadzenButton Text="Cancel" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Light" />
					</RadzenStack>
				</RadzenStack>
			</RadzenStack>
		);

		if (!(result is null) && result && configName != conf.Name)
		{
			if (String.IsNullOrWhiteSpace(configName))
			{
				await layout!.DisplayToastAsync(MainLayout.toastType.error, "New config name cannot be blank!");
				return;
			}

			configName = configName.Trim();
			string configPath = string.Empty;

			if (conf.ConfigType == Nginx.ConfigFile.enuConfigType.Site)
				configPath = Path.Combine(nginx.SitesAvailable, configName);
			else
				configPath = Path.Combine(nginx.SharedFiles, configName);

			if (File.Exists(configPath))
			{
				await layout!.DisplayToastAsync(MainLayout.toastType.error, $"Config with new name of %ss%{configName}%se% already exists!");
				return;
			}

			try
			{
				// Output new file
				await File.WriteAllTextAsync(configPath, conf.FileContents);

				// Check enabled status
				if (conf.Enabled)
				{
					string oldName = conf.Name;
					string oldPath = conf.ConfigPath;

					// Disable current file
					nginx.ToggleSiteEnabled(conf);

					// Enable new file
					conf.Name = configName;
					conf.ConfigPath = configPath;
					nginx.ToggleSiteEnabled(conf);

					// Reset values (so messages below are accurate)
					conf.Name = oldName;
					conf.ConfigPath = oldPath;
				}

				File.Delete(conf.ConfigPath);
				await RefreshConfigs(false);

				await layout!.DisplayToastAsync(MainLayout.toastType.success, $"Config %ss%{conf.Name}%se% has been renamed to %ss%{configName}%se%!");
			}
			catch (Exception ex)
			{
				if (ex.GetType() == typeof(System.UnauthorizedAccessException))
				{
					await layout!.DisplayToastAsync(MainLayout.toastType.error, $"File permission error occurred while renaming config %ss%{conf.Name}%se%!");
				}
				else
				{
					await layout!.DisplayToastAsync(MainLayout.toastType.error, $"Error occurred while renaming config to %ss%{configName}%se%!");
				}
			}
		}
	}

	private async Task AutoFormatConfig(Nginx.ConfigFile conf)
	{
		try
		{
			string message = layout!.StyleMessage(MainLayout.toastType.success, $"Are you sure you want to auto format config %ss%{conf.Name}%se%?  This will attempt to make the config nicer by replacing tabs with spaces, you may want to save before attempting this!");
			bool? confirm = await DialogService.Confirm(message, "Format Config", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No", CloseDialogOnOverlayClick = true });

			if (confirm.HasValue && confirm.Value)
			{
				conf.FileContents = conf.FileContents.Replace("    ", "\t").Replace("  ", "    ").Replace("\t", "    ");
				await layout!.DisplayToastAsync(MainLayout.toastType.info, $"Config %ss%{conf.Name}%se% has been auto formatted!");
			}
		}
		finally
		{
			await InvokeAsync(() => StateHasChanged());
		}
	}

	private async Task AddConfig()
	{
		string configName = string.Empty;
		Services.Nginx.ConfigFile.enuConfigType configType = Nginx.ConfigFile.enuConfigType.Site;
		var result = await DialogService.OpenAsync("Add Config", ds =>
			@<RadzenStack Gap="1.5rem">
				<RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Please enter the name of the config:</RadzenText>
				<RadzenTextBox @bind-Value=@configName class="w-100" />
				<RadzenRadioButtonList @bind-Value=@configType TValue="Services.Nginx.ConfigFile.enuConfigType" class="mb-2">
					<Items>
						<RadzenRadioButtonListItem Text="@Services.Nginx.ConfigFile.enuConfigType.Site.ToString()" Value="Services.Nginx.ConfigFile.enuConfigType.Site" />
						<RadzenRadioButtonListItem Text="@Services.Nginx.ConfigFile.enuConfigType.Shared.ToString()" Value="Services.Nginx.ConfigFile.enuConfigType.Shared" />
					</Items>
				</RadzenRadioButtonList>
				<RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
					<RadzenStack Orientation="Orientation.Horizontal">
						<RadzenButton Text="Ok" Click="() => ds.Close(true)" Style="width: 80px;" />
						<RadzenButton Text="Cancel" Click="() => ds.Close(false)" ButtonStyle="ButtonStyle.Light" />
					</RadzenStack>
				</RadzenStack>
			</RadzenStack>
	);

		if (!(result is null) && result)
		{
			if (String.IsNullOrWhiteSpace(configName))
			{
				await layout!.DisplayToastAsync(MainLayout.toastType.error, "Config name cannot be blank!");
				return;
			}

			configName = configName.Trim();
			string configPath = string.Empty;

			if (configType == Nginx.ConfigFile.enuConfigType.Site)
				configPath = Path.Combine(nginx.SitesAvailable, configName);
			else
				configPath = Path.Combine(nginx.SharedFiles, configName);

			if (File.Exists(configPath))
			{
				await layout!.DisplayToastAsync(MainLayout.toastType.error, $"Config with the name %ss%{configName}%se% already exists!");
				return;
			}

			try
			{
				selectedConf = null;
				await InvokeAsync(() => StateHasChanged());

				await File.WriteAllTextAsync(configPath, "");
				await RefreshConfigs(false, selectConf: configName);

				await layout!.DisplayToastAsync(MainLayout.toastType.success, $"Config %ss%{configName}%se% has been added!");
			}
			catch (Exception ex)
			{
				if (ex.GetType() == typeof(System.UnauthorizedAccessException))
				{
					await layout!.DisplayToastAsync(MainLayout.toastType.error, $"File permission error occurred while adding config %ss%{configName}%se%!");
				}
				else
				{
					await layout!.DisplayToastAsync(MainLayout.toastType.error, $"Error occurred while adding config %ss%{configName}%se%!");
				}
			}
			finally
			{
				await InvokeAsync(() => StateHasChanged());
			}
		}
	}

	private async Task DeleteConfig(Nginx.ConfigFile conf)
	{
		string message = layout!.StyleMessage(MainLayout.toastType.success, $"Are you sure you want to delete config %ss%{conf.Name}%se%?");
		bool? confirm = await DialogService.Confirm(message, "Delete Config", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No", CloseDialogOnOverlayClick = true });

		if (confirm.HasValue && confirm.Value)
		{
			// Make sure config is not enabled
			if (conf.Enabled)
				nginx.ToggleSiteEnabled(conf);

			File.Delete(conf.ConfigPath);
			await RefreshConfigs(false);

			await layout!.DisplayToastAsync(MainLayout.toastType.success, $"Config %ss%{conf.Name}%se% has been deleted!");
		}
	}

	private async Task EditConfig(Nginx.ConfigFile conf)
	{
		var result = await DialogService.OpenAsync("Edit Config - " + conf.Name, ds =>
			@<RadzenCard>
				<RadzenButton Click=@(() => SaveConfig(conf)) Disabled="busyRefreshing" Text="Save" Icon="save" BusyText="Saving..." IsBusy="conf.busySaving" class="rz-background-color-success-dark" Style="margin-right: 25px;" />
				<RadzenButton Click=@(() => AutoFormatConfig(conf)) Disabled="busyRefreshing" Text="Auto Format" Icon="brush" BusyText="Formatting..." IsBusy="conf.busySaving" class="rz-background-color-primary-dark" Style="margin-right: 5px;" />
				<RadzenButton Click=@(() => RevertConfig(conf)) Disabled="busyRefreshing" Text="Revert" Icon="upload_file" BusyText="Reverting..." IsBusy="conf.busySaving" class="rz-background-color-primary-dark" />

				<RadzenText TextStyle="TextStyle.Subtitle2" class="rz-mt-5" TagName="TagName.H3">Configuration:</RadzenText>
				<RadzenTextArea Value="@conf.FileContents" Change=@(value => @conf.FileContents = value) Cols="120" Rows="36" Style="@(configCurrentCSS)" />
				<br />

				<RadzenStack Orientation="Orientation.Horizontal">
					<RadzenCheckBox TValue="bool" Value="@(!configCurrentCSS.Contains("nowrap"))" Name="@(conf.Name + "_wordwrap")" Change="@((args) => configCurrentCSS = defaultConfigCSS + (args ? "" : configNoWrapCSS))" />
					<RadzenLabel Text="Word wrap" Component="@(conf.Name + "_wordwrap")" />
				</RadzenStack>
			</RadzenCard>
		,new DialogOptions() { Width = "1200px", Height = "850px" });
	}
}